<!doctype html>
<html>
<head>
    <title>Gil Eats</title>
    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css?family=Indie+Flower" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <script src="js/utils.js"></script>
</head>
<body>

    <!-- Example layout boilerplate -->
    <header class="page-header">
        <div class="container">
            <nav>
                <a href="/"><span class="code">Gil Eats</span></a>
                <a href="/">
                    <h2>
                        <img src="../img/gil.png" class="logo" />
                    </h2>
                </a>
            </nav>
        </div>
    </header>

        <!-- Map with places - everyone always sees this!-->
        <div id="gmap" class="contact-map"></div>

        <div class="container main">

            <!-- Show the Add Eats button if not authenticated -->
            <div id="pre-auth-section" style="display:none;">
                <a href="" id="authlink" class="button">Add Eats</a>
                <span class="info">This will allow upload to your Dropbox, but it won't render on the map unless you change the code... this is Gil's Eats!</span>
            </div>

        </div>

        <!-- User sees this section after authentication, to add a new place -->
        <div id="authed-section" style="display:none;">

        <div class="form">
            <form class="register-form rating-form" onSubmit="return uploadFiles()">
                <!-- Restaurant and location search-->
                <input id="address-input" class="controls" type="text" placeholder="Enter a location">
                <input type="hidden" placeholder="location" id="location"/>
                <input type="text" placeholder="date" id="date"/>

                <!--Interactive Stars!-->
                <fieldset class="form-group">
                    <legend class="form-legend">Rating:</legend>
                        <div class="form-item">
                            <input id="rating-5" name="rating" type="radio" value="5" />
                            <label for="rating-5" data-value="5">
                                <span class="rating-star">
                                    <i class="fa fa-star-o"></i>
                                    <i class="fa fa-star"></i>
                                </span>
                                <span class="ir">5</span>
                            </label>
                            <input id="rating-4" name="rating" type="radio" value="4" />
                            <label for="rating-4" data-value="4">
                                <span class="rating-star">
                                    <i class="fa fa-star-o"></i>
                                    <i class="fa fa-star"></i>
                                </span>
                                <span class="ir">4</span>
                            </label>
                            <input id="rating-3" name="rating" type="radio" value="3" />
                            <label for="rating-3" data-value="3">
                                <span class="rating-star">
                                    <i class="fa fa-star-o"></i>
                                    <i class="fa fa-star"></i>
                                </span>
                                <span class="ir">3</span>
                            </label>
                            <input id="rating-2" name="rating" type="radio" value="2" />
                            <label for="rating-2" data-value="2">
                                <span class="rating-star">
                                    <i class="fa fa-star-o"></i>
                                    <i class="fa fa-star"></i>
                                </span>
                                <span class="ir">2</span>
                            </label>
                            <input id="rating-1" name="rating" type="radio" value="1" />
                            <label for="rating-1" data-value="1">
                                <span class="rating-star">
                                    <i class="fa fa-star-o"></i>
                                    <i class="fa fa-star"></i>
                                </span>
                                <span class="ir">1</span>
                            </label>
                        </div>
                    </fieldset>

                <input type="textarea" placeholder="review" id="review"/>
                <input type="hidden" id="access-token" placeholder="Access token" />
                <input type="file" id="file-upload" placeholder="picture"/>
                <button type="submit">nomnom</button> 

                <!-- A place to show the status of the upload -->
                <h2 id="results"></h2>

            </form>
         </div>

            <p>You have successfully authenticated. Below are the contents of your root directory. They were fetched using the SDK and access token.</p>
             <ul id="files"></ul>
        </div>

  <script src="js/jquery.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>

  <!-- Google maps API, note that we include Places library -->
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?key=AIzaSyDhmVSj7xyJsbfI6CmG4AwSa8AKiA7_VaY&libraries=places"></script>
  <script type="text/javascript" src="js/gmaps.js"></script>
  <script type="text/javascript" src="js/eats.js"></script>

  <script>



    /* Register a service worker for caching files
       Commented out for now so the cache isn't active 
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').then(function(registration) {
            // Registration was successful
            console.log('ServiceWorker registration successful with scope: ', registration.scope);

       }).catch(function(err) {
           // registration failed :(
           console.log('ServiceWorker registration failed: ', err);
     });
    }*/

    var CLIENT_ID = '42zjexze6mfpf7x';
    
    function getCookieToken() {
        return $.cookie('gileats');    
     }

    // Parses the url and gets the access token if it is in the urls hash
    function getAccessToken() {
        // First check to see if we have a cookie token
        if (!!getCookieToken()) {

            // Does the url have a token?
            var has_token = !!utils.parseQueryString(window.location.hash).access_token;
            
            // If we don't have a token, return False so the user authenticates
            if (!has_token) {
                return has_token;
            } else {

               // If we do, the user has authenticated but it's not set yet as a cookie
               var access_token = utils.parseQueryString(window.location.hash).access_token;

               // If gileats folder doesn't exist, create it
               createFolder('','gileats',access_token) // this is a promise
               .then(function(response) {

                   // Set the access_token in the gileats cookie
                   $.cookie("gileats",access_token);
               });
            }
        }

       // At this point, if we haven't returned false, we can return the cookie that was set
       return getCookieToken();
    }

    // If the user was just redirected from authenticating, the urls hash will
    // contain the access token.
    function isAuthenticated() { 
        return !!getAccessToken();
    }

    // Render a list of items to #files
    function renderItems(items) {
        var filesContainer = document.getElementById('files');
        items.forEach(function(item) {
            var li = document.createElement('li');
            li.innerHTML = item.name;
            filesContainer.appendChild(li);
         });
     }

    // This example keeps both the authenticate and non-authenticated setions
    // in the DOM and uses this function to show/hide the correct section.
    function showPageSection(elementId) {
        document.getElementById(elementId).style.display = 'block';
    }

    if (isAuthenticated()) {

        // Fill in the date field
        document.getElementById('date').value = Date();
        
        showPageSection('authed-section');

        // Set the hidden field to be the authentication token
        var access_token = getAccessToken();
        document.getElementById('access-token').value = access_token; 

        // Create an instance of Dropbox with the access token 
        var dbx = new Dropbox({ accessToken: access_token });

        // fetch and render the files in the users root directory.
        dbx.filesListFolder({path: '/gileats'})
            .then(function(response) {
                renderItems(response.entries);
             })
            .catch(function(error) {
                console.error(error);
             });
        } else {
             
        showPageSection('pre-auth-section');

        // Set the login anchors href using dbx.getAuthenticationUrl()
        var dbx = new Dropbox({ clientId: CLIENT_ID });
        var authUrl = dbx.getAuthenticationUrl('http://localhost:8080/auth');
        document.getElementById('authlink').href = authUrl;

    }

    </script>
</body>
</html>
